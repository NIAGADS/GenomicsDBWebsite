#!/bin/sh
# update config files (perform substitutions)

PROPERTIES_FILE=$1
SITE_HOME=$2
WEBAPP=$3
PROJECT_ID=$4

GUS_HOME=$SITE_HOME/gus_home
PROJECT_HOME=$SITE_HOME/project_home

if test -f "$PROPERTIES_FILE"; then
  echo "Pulling properties from $PROPERTIES_FILE"
else
    echo "$PROPERTIES_FILE does not exist - exiting" 
    return 1
fi

prop() {
    grep "^${1}=" ${PROPERTIES_FILE}|cut -d'=' -f2
}

HOST_URL=$(prop 'HOST_URL')
ALT_BUILD_LINK=$(prop 'ALT_BUILD_LINK')

if [ $ALT_BUILD_LINK = "auto" ]; then 
  if [ $PROJECT_ID = "GRCh38" ]; then
    ALT_BUILD_LINK=${HOST_URL}/genomics37
  else 
    ALT_BUILD_LINK=${HOST_URL}/genomics38
  fi
fi

echo "Setting ALT_BUILD_LINK=$ALT_BUILD_LINK"

GENOME_BROWSER_SERVICE_BASE_URL=${HOST_URL}/${WEBAPP}/service
LOCUS_ZOOM_SERVICE_BASE_URL=${HOST_URL}/${WEBAPP}/service

echo "Setting SERVICE URLS=$GENOME_BROWSER_SERVICE_BASE_URL"

# set webapp properties
echo "Setting webapp properties (webapp.prop file)"
cp $PROJECT_HOME/GenomicsDBWebsite/Site/config/webapp.prop.sample $GUS_HOME/config/webapp.prop 
sed -i "s|@WEBAPP@|$WEBAPP|g" $GUS_HOME/config/webapp.prop
sed -i "s|@PROJECT_ID@|$PROJECT_ID|g" $GUS_HOME/config/webapp.prop
sed -i "s|@GOOGLE_ANALYTICS_ID@|$(prop 'GOOGLE_ANALYTICS_ID')|g" $GUS_HOME/config/webapp.prop
sed -i "s|@CORS_ALLOWED_ORIGINS@|$(prop 'CORS_ALLOWED_ORIGINS')|g" $GUS_HOME/config/webapp.prop
# TODO: add production build flag to webapp.prop if $BUILD == "prod"

echo "Copying gus.config"
cp $PROJECT_HOME/install/gus.config.sample $GUS_HOME/config/gus.config

# model.props (specific for genome build b/c of third-party URLs)
echo "Setting model properties (model.prop file)"
cp $PROJECT_HOME/GenomicsDBWebsite/Model/config/$PROJECT_ID/model.prop.sample $GUS_HOME/config/$PROJECT_ID/model.prop
sed -i "s|@WEBAPP@|$WEBAPP|g" $GUS_HOME/config/$PROJECT_ID/model.prop
sed -i "s|@SITE_ADMIN_EMAIL@|$(prop 'SITE_ADMIN_EMAIL')|g" $GUS_HOME/config/$PROJECT_ID/model.prop
sed -i "s|@GENOME_BUILD@|$(prop 'GENOME_BUILD')|g" $GUS_HOME/config/$PROJECT_ID/model.prop
sed -i "s|@PROJECT_ID@|$PROJECT_ID|g" $GUS_HOME/config/$PROJECT_ID/model.prop
sed -i "s|@GENCODE_VERSION@|$(prop 'GENCODE_VERSION')|g" $GUS_HOME/config/$PROJECT_ID/model.prop
sed -i "s|@DBSNP_VERSION@|$(prop 'DBSNP_VERSION')|g" $GUS_HOME/config/$PROJECT_ID/model.prop
sed -i "s|@ALT_BUILD_LINK@|$ALT_BUILD_LINK|g" $GUS_HOME/config/$PROJECT_ID/model.prop
sed -i "s|@GENOME_BROWSER_SERVICE_BASE_URL@|$GENOME_BROWSER_SERVICE_BASE_URL|g" $GUS_HOME/config/$PROJECT_ID/model.prop
sed -i "s|@LOCUS_ZOOM_SERVICE_BASE_URL@|$LOCUS_ZOOM_SERVICE_BASE_URL|g" $GUS_HOME/config/$PROJECT_ID/model.prop 

# model-config
echo "Setting model configuration (model-config.xml file)"
cp $PROJECT_HOME/GenomicsDBWebsite/Model/config/model-config.xml.sample $GUS_HOME/config/$PROJECT_ID/model-config.xml
sed -i "s|@MODEL@|$PROJECT_ID|g" $GUS_HOME/config/$PROJECT_ID/model-config.xml
sed -i "s|@SITE_ADMIN_EMAIL@|$(prop 'SITE_ADMIN_EMAIL')|g" $GUS_HOME/config/$PROJECT_ID/model-config.xml
sed -i "s|@DB_USER@|$(prop 'WEB_DB_USER')|g" $GUS_HOME/config/$PROJECT_ID/model-config.xml
sed -i "s|@DB_PASSWORD@|$(prop 'WEB_DB_PASSWORD')|g" $GUS_HOME/config/$PROJECT_ID/model-config.xml
sed -i "s|@DB_HOST@|$(prop 'WEB_DB_HOST')|g" $GUS_HOME/config/$PROJECT_ID/model-config.xml
sed -i "s|@DB_PORT@|$(prop 'WEB_DB_PORT')|g" $GUS_HOME/config/$PROJECT_ID/model-config.xml
sed -i "s|@DB_NAME@|$(prop 'WEB_DB_NAME')|g" $GUS_HOME/config/$PROJECT_ID/model-config.xml 

# tomcat-context.xml
echo "Setting tomcat context (tomcat-context.xml file)"
cp $PROJECT_HOME/GenomicsDBWebsite/Site/config/tomcat-context.xml.sample $PROJECT_HOME/config/tomcat-context.xml
sed -i "s|@MODEL@|$PROJECT_ID|g" $PROJECT_HOME/config/tomcat-context.xml
sed -i "s|@WEBAPP@|$WEBAPP|g" $PROJECT_HOME/config/${WEBAPP}.xml
echo "Configuring Tomcat Manager (tomcat-users.xml / tomcat-manager-context.xml)"
cp $PROJECT_HOME/GenomicsDBWebsite/Site/config/tomcat-users.xml.sample $PROJECT_HOME/config/tomcat-users.xml
sed -i "s|@TOMCAT_MANAGER_PASSWORD@|$(prop 'TOMCAT_MANAGER_PASSWORD')|g" $PROJECT_HOME/config/tomcat-users.xml
# cp $PROJECT_HOME/GenomicsDBWebsite/Site/config/tomcat-manager-context.xml $CATALINA_HOME/webapps/manager/META-INF/context.xml
